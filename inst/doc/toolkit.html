<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Toolkit</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Toolkit</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(rray)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(magrittr)</a></code></pre></div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>One of the big goals for rray is to be a general purpose toolkit for working with arrays. A requirement of this is that you shouldn’t have to opt into using rray objects to be able to take advantage of broadcasting or the ability to use any of the <code>rray_*()</code> functions. That requirement has been at the core of rray development, and it means that you can use base R vector/matrix/array objects with any of the rray functions, and still get a base R object back out.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">nrow =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">nrow =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># Base R matrices, added with broadcasting</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">rray_add</span>(x, y)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt;      [,1] [,2] [,3]</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt; [1,]    2    4    6</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt; [2,]    4    6    8</span></a></code></pre></div>
</div>
<div id="axes" class="section level2">
<h2>Axes</h2>
<p>Many of the functions in rray are applied “along an axis”. With base R, you might be used to the <code>MARGIN</code> argument when specifying the dimension to apply a function over. In rray, you’ll use <code>axes</code> (or <code>axis</code>, depending on the function). In short, these two are <em>complements</em> of one another. Ignoring the fact that rray doesn’t drop length 1 dimensions, notice that the values computed in the example below are the same, even though the dimensions to compute over look different.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">rray_sum</span>(x, <span class="dt">axes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; , , 1</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; [1,]    3    7</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; , , 2</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; [1,]   11   15</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">apply</span>(x, <span class="dt">MARGIN =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">FUN =</span> sum)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; [1,]    3   11</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; [2,]    7   15</span></a></code></pre></div>
<p>I find that <code>axes</code> is a more intuitive way to specify the dimensions. This is because with <code>axes</code>, you list the dimensions that you are allowing to change in some way. In the above example, <code>axes = 1</code> was specified which <em>guarantees</em> that the result will have the same dimensions as <code>x</code> everywhere except in the first dimension, which will have length 1, no matter what. In other words, the dimensions change as: <code>(2, 2, 2) -&gt; (1, 2, 2)</code>.</p>
</div>
<div id="binding" class="section level2">
<h2>Binding</h2>
<p>Reducers aren’t the only functions with this <code>axes</code> guarantee. With <code>rray_bind()</code>, you specify the <code>.axis</code> that you want to bind along. This has the same guarantee that only the <code>.axis</code> specified will be changing. The only caveat here is that the inputs are first broadcast to a common dimension (ignoring the <code>.axis</code> dimension) before the binding is carried out. A few examples might be helpful:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># (5, 1)</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">x &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co"># (3)</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">y &lt;-<span class="st"> </span><span class="dv">6</span><span class="op">:</span><span class="dv">8</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">rray_bind</span>(x, y, <span class="dt">.axis =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; [5,]    5</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt; [6,]    6</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; [7,]    7</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; [8,]    8</span></a></code></pre></div>
<p>This works by first finding the common dimensions between <code>x</code> and <code>y</code>, ignoring the <code>.axis</code> dimension. So in this case the common dimension is <code>(., 1)</code> where the <code>.</code> represents whatever dimension is actually there for that object. The final result after binding the inputs together will also have a <code>(., 1)</code> shape, where the <code>.</code> will be the sum of all of the 1st dimension sizes of the inputs (in this case <code>5 + 3 = 8</code>).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># (5, 1) where `. = 5` from x</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">x_broadcast &lt;-<span class="st"> </span><span class="kw">rray_broadcast</span>(x, <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">x_broadcast</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt; [5,]    5</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co"># (3, 1) where `. = 3` from y</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">y_broadcast &lt;-<span class="st"> </span><span class="kw">rray_broadcast</span>(y, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">y_broadcast</a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt; [1,]    6</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt; [2,]    7</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt; [3,]    8</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="kw">rray_bind</span>(x_broadcast, y_broadcast, <span class="dt">.axis =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt; [5,]    5</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt; [6,]    6</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt; [7,]    7</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28"><span class="co">#&gt; [8,]    8</span></a></code></pre></div>
<p>The <code>.axis</code> is actually taken account when finding the common dimensions. This means that you can bind along an axis that is higher in dimensionality than any of the inputs. For example, you can bind two matrices along the third dimension.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">rray_bind</span>(x, x, <span class="dt">.axis =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; , , 1</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; [5,]    5</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co">#&gt; , , 2</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="co">#&gt; [5,]    5</span></a></code></pre></div>
<p>This works by finding the common dimension between <code>x</code> and <code>x</code>, which is just <code>(5, 1)</code>, and then checking that against the <code>.axis</code>. If <code>.axis</code> is implicitly along a higher dimension, the common dimension is extended as needed. In this case it is extended to <code>(5, 1, 1)</code> to match the fact that you are binding along the third dimension. The inputs are broadcast to that shape, and then bound together.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">x_broadcast &lt;-<span class="st"> </span><span class="kw">rray_broadcast</span>(x, <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">x_broadcast</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; , , 1</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt; [5,]    5</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="kw">rray_bind</span>(x_broadcast, x_broadcast, <span class="dt">.axis =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; , , 1</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt; [5,]    5</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="co">#&gt; , , 2</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="co">#&gt; [3,]    3</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="co">#&gt; [4,]    4</span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="co">#&gt; [5,]    5</span></a></code></pre></div>
</div>
<div id="dimension-dropping" class="section level2">
<h2>Dimension dropping</h2>
<p>One thing you will immediately notice when working with rray is that it often tries <em>not</em> to drop dimensions. This happens most apparently in subsetting, and in the reducers like <code>rray_sum()</code> and is in stark contrast to base R.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">x_rray &lt;-<span class="st"> </span><span class="kw">as_rray</span>(x)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">x[<span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt; [1] 1 4</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">x_rray[<span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt; &lt;rray&lt;int&gt;[,2][1]&gt;</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt; [1,]    1    4</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="kw">apply</span>(x, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; [1]  6 15</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="kw">rray_sum</span>(x, <span class="dt">axes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt; [1,]    6   15</span></a></code></pre></div>
<p>The rationale for this has to do with how broadcasting works. When dimensions aren’t dropped, operations such as the following are natural:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">x_rray <span class="op">/</span><span class="st"> </span><span class="kw">rray_sum</span>(x_rray, <span class="dt">axes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; &lt;rray&lt;dbl&gt;[,2][3]&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt;           [,1]      [,2]</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; [1,] 0.1666667 0.2666667</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; [2,] 0.3333333 0.3333333</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; [3,] 0.5000000 0.4000000</span></a></code></pre></div>
<p>This doesn’t work as you might expect with base R, and can result in a tragic error since partial recycling kicks in and you don’t get an error.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">x <span class="op">/</span><span class="st"> </span><span class="kw">apply</span>(x, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt;           [,1]      [,2]</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt; [1,] 0.1666667 0.2666667</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; [2,] 0.1333333 0.8333333</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt; [3,] 0.5000000 0.4000000</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co"># Equivalent to </span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">col_sums &lt;-<span class="st"> </span><span class="kw">apply</span>(x, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">partially_recycled &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(col_sums, <span class="dt">times =</span> <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">partially_recycled</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt; [1,]    6   15</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt; [2,]   15    6</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt; [3,]    6   15</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">x <span class="op">/</span><span class="st"> </span>partially_recycled</a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co">#&gt;           [,1]      [,2]</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#&gt; [1,] 0.1666667 0.2666667</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co">#&gt; [2,] 0.1333333 0.8333333</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co">#&gt; [3,] 0.5000000 0.4000000</span></a></code></pre></div>
<p>This works nicely in rray because of two reasons, both are necessary:</p>
<ul>
<li>The dimensions aren’t dropped</li>
<li>Broadcasting kicks in</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">x_sum &lt;-<span class="st"> </span><span class="kw">rray_sum</span>(x_rray, <span class="dt">axes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co"># When `/` is called, the inputs are broadcast to the same shape, like this</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">dim &lt;-<span class="st"> </span><span class="kw">rray_dim_common</span>(x_rray, x_sum)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">x_broadcast &lt;-<span class="st"> </span><span class="kw">rray_broadcast</span>(x_rray, dim)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">x_sum_broadcast &lt;-<span class="st"> </span><span class="kw">rray_broadcast</span>(x_sum, dim)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">x_broadcast</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt; &lt;rray&lt;int&gt;[,2][3]&gt;</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt; [1,]    1    4</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt; [2,]    2    5</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; [3,]    3    6</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"></a>
<a class="sourceLine" id="cb11-15" data-line-number="15">x_sum_broadcast</a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt; &lt;rray&lt;dbl&gt;[,2][3]&gt;</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt;      [,1] [,2]</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#&gt; [1,]    6   15</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="co">#&gt; [2,]    6   15</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#&gt; [3,]    6   15</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"></a>
<a class="sourceLine" id="cb11-22" data-line-number="22">x_broadcast <span class="op">/</span><span class="st"> </span>x_sum_broadcast</a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="co">#&gt; &lt;rray&lt;dbl&gt;[,2][3]&gt;</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="co">#&gt;           [,1]      [,2]</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"><span class="co">#&gt; [1,] 0.1666667 0.2666667</span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="co">#&gt; [2,] 0.3333333 0.3333333</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="co">#&gt; [3,] 0.5000000 0.4000000</span></a></code></pre></div>
<p>If you do want to drop dimensions with rray, you can explicitly call <code>rray_squeeze()</code> afterwards. As a rule of thumb, it is much easier to drop dimensions explicitly than it is to recover them.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">x_rray <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw">rray_sum</span>(<span class="dt">axes =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw">rray_squeeze</span>(<span class="dt">axes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt; &lt;rray&lt;dbl&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; [1]  6 15</span></a></code></pre></div>
<p>If you come from NumPy, you might be used to reducers dropping the axis you reduce over. I think this is a mistake, and there have been a number of discussions on the NumPy forums about this choice. Here is why:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># This is the result you'd get in a NumPy sum. The 1st dimension is dropped</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">x_sum_dropped &lt;-<span class="st"> </span><span class="kw">rray_squeeze</span>(<span class="kw">rray_sum</span>(x_rray, <span class="dt">axes =</span> <span class="dv">1</span>), <span class="dt">axes =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">x_sum_dropped</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; &lt;rray&lt;dbl&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; [1]  6 15</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co"># Now broadcasting doesn't work!</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">x_rray <span class="op">/</span><span class="st"> </span>x_sum_dropped</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt; Error: Non-broadcastable dimensions: (3, 2) and (2).</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co"># So you have to add back the dimension</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co"># (numpy has slightly cleaner ways to do this, but it's still an extra step)</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">x_sum_reshaped &lt;-<span class="st"> </span><span class="kw">rray_expand</span>(x_sum_dropped, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">x_rray <span class="op">/</span><span class="st"> </span>x_sum_reshaped</a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; &lt;rray&lt;dbl&gt;[,2][3]&gt;</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt;           [,1]      [,2]</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt; [1,] 0.1666667 0.2666667</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt; [2,] 0.3333333 0.3333333</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#&gt; [3,] 0.5000000 0.4000000</span></a></code></pre></div>
<p>For the curious, Julia’s implementation of reducers works similarly to rray.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
